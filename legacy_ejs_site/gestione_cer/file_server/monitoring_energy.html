<!DOCTYPE html>
<html lang="it">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Monitora la tua CER - SunFai</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
  <script src="//cdn.amcharts.com/lib/4/core.js"></script>
  <script src="//cdn.amcharts.com/lib/4/charts.js"></script>
  <script src="//cdn.amcharts.com/lib/4/maps.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap">
  <style>
    :root {
      --primary-color: #4C8C2E;
      --secondary-color: #F25C05;
      --accent-color: #F2B705;
      --background-color: #F2F2F2;
      --text-color: #333333;
      --card-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      --spacing-sm: 8px;
      --spacing-md: 16px;
      --spacing-lg: 24px;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Poppins', sans-serif;
      background-color: var(--background-color);
      color: var(--text-color);
      /* line-height: 1.6; */
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
      padding: var(--spacing-md);
      margin: 0;
    }

    .container {
      width: 100%;
      max-width: 1200px;
      margin: 0 auto;
      padding-top: 35px;
    }

    /* Header & Navigation */
    header {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      background-color: white;
      padding: var(--spacing-sm) var(--spacing-md);
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      z-index: 100;
    }

    .logo-link {
      display: flex;
      align-items: center;
      text-decoration: none;
      color: var(--primary-color);
      font-weight: 600;
      gap: var(--spacing-sm);
    }

    .logo-icon {
      width: 24px;
      height: 24px;
      fill: var(--primary-color);
    }

    .logo-text {
      display: inline-block;
      font-size: 1.2rem;
    }

    /* Main content */
    h1 {
      font-size: 2rem;
      color: var(--primary-color);
      margin-bottom: var(--spacing-md);
      text-align: center;
      /* font-weight: 700; */
    }

    /* Stats Card */
    .stats-card {
      background-color: white;
      padding: var(--spacing-lg);
      border-radius: 10px;
      box-shadow: var(--card-shadow);
      width: 100%;
      max-width: 650px;
      text-align: center;
      margin-bottom: 10px;
      padding-top: 1px;
      padding-bottom: 1px;
    }

    .current-power {
      margin-bottom: 1px;
    }

    .current-power .label {
      font-size: 1.2rem;
      color: var(--secondary-color);
    }

    .current-power .value {
      font-size: 2rem;
      color: var(--secondary-color);
      font-weight: bold;
      display: block;
      margin-top: var(--spacing-sm);
    }

    .period-power {
      font-size: 2rem;
    }

    .period-power .label {
      font-size: 1.2rem;
      color: var(--text-color);
    }

    .period-power .value {
      font-size: 1.2rem;
      color: var(--secondary-color);
      font-weight: 600;
    }

    /* Filters */
    .filters-container {
      width: 100%;
      margin-bottom: 1px;
    }

    .date-filters {
      display: flex;
      flex-direction: column;
      gap: var(--spacing-sm);
      margin-bottom: var(--spacing-md);
    }

    .filter-group {
      display: flex;
      flex-direction: column;
    }

    .filter-label {
      font-weight: 500;
      color: var(--primary-color);
      margin-bottom: 4px;
    }

    .date-input {
      width: 100%;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-family: 'Poppins', sans-serif;
      color: var(--secondary-color);
    }

    .filter-button {
      padding: 12px 20px;
      font-size: 1rem;
      font-weight: 600;
      font-family: 'Poppins', sans-serif;
      background-color: var(--primary-color);
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: background-color 0.3s ease, transform 0.2s ease;
      width: 100%;
    }

    .filter-button:hover {
      background-color: #3c7023;
      transform: translateY(-2px);
    }

    .filter-button:active {
      transform: translateY(1px);
    }

    /* Chart */
    .chart-container {
      width: 100%;
      height: auto;
      max-width: 805px;
      max-height: 585px;
      aspect-ratio: 16/9;
      background-color: white;
      border-radius: 12px;
      padding: var(--spacing-md);
      box-shadow: var(--card-shadow);
      margin-bottom: var(--spacing-md);
      min-height: 250px;
      padding-bottom: 1px;
    }

    .div_graficoMonitoraggio {
      width: 100%;
      height: auto;
      max-width: 805px;
      max-height: 585px;
      aspect-ratio: 16/9;
    }

    canvas {
      width: 100% !important;
      height: 100% !important;
    }

    /* Last update info */
    .last-update {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
      font-size: 0.85rem;
      color: var(--accent-color);
      margin-bottom: var(--spacing-md);
    }

    .last-update .value {
      font-weight: 500;
    }

    /* Footer */
    footer {
      margin-top: auto;
      padding: var(--spacing-md) 0;
      text-align: center;
      font-size: 0.85rem;
      color: var(--secondary-color);
      width: 100%;
    }

    /* Responsive adjustments */
    @media (min-width: 768px) {
      h1 {
        font-size: 2.2rem;
      }

      .date-filters {
        flex-direction: row;
        align-items: flex-end;
        gap: var(--spacing-md);
      }

      .filter-group {
        flex: 1;
      }

      .filter-button {
        width: auto;
        min-width: 160px;
      }

      .chart-container {
        min-height: 400px;
      }
    }

    @media (max-width: 480px) {
      .current-power .value {
        font-size: 2rem;
      }

      .logo-text {
        display: none;
      }
    }
  </style>
</head>

<body>
  <header>
    <a href="https://www.sun-fai.org" class="logo-link">
      <svg class="logo-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50">
        <path
          d="M 25 1.0507812 C 24.7825 1.0507812 24.565859 1.1197656 24.380859 1.2597656 L 1.3808594 19.210938 C 0.95085938 19.550938 0.8709375 20.179141 1.2109375 20.619141 C 1.5509375 21.049141 2.1791406 21.129062 2.6191406 20.789062 L 4 19.710938 L 4 46 C 4 46.55 4.45 47 5 47 L 19 47 L 19 29 L 31 29 L 31 47 L 45 47 C 45.55 47 46 46.55 46 46 L 46 19.710938 L 47.380859 20.789062 C 47.570859 20.929063 47.78 21 48 21 C 48.3 21 48.589063 20.869141 48.789062 20.619141 C 49.129063 20.179141 49.049141 19.550938 48.619141 19.210938 L 25.619141 1.2597656 C 25.434141 1.1197656 25.2175 1.0507812 25 1.0507812 z M 35 5 L 35 6.0507812 L 41 10.730469 L 41 5 L 35 5 z">
        </path>
      </svg>
      <span class="logo-text">Monitora la tua CER con SunFai</span>
    </a>
  </header>

  <div class="container">
    <div class="stats-card" style="margin-left: auto; margin-right: auto;">
      <div class="current-power">
        <span class="label">A Dalmine la nostra CER negli ultimi 15 minuti ha condiviso in rete:</span>
        <span class="value" id="current-power-value">-- kWh</span>
      </div>

      <div class="period-power">
        <span class="label">Somma totale del periodo:</span>
        <span class="value" id="period-power-value">-- kWh</span>
      </div>

      <div class="filters-container">
        <button id="toggleFilters" class="filter-button" style="margin-bottom: var(--spacing-md);">Mostra
          filtri</button>

        <div id="filterSection" class="date-filters" style="display: none;">
          <div class="filter-group">
            <label class="filter-label">Data di partenza:</label>
            <input type="datetime-local" id="date_start" class="date-input">
          </div>

          <div class="filter-group">
            <label class="filter-label">Data di fine:</label>
            <input type="datetime-local" id="date_end" class="date-input">
          </div>

          <button onclick="fetchData()" class="filter-button">Applica filtri</button>
        </div>
      </div>
    </div>

    <div id="div_graficoMonitoraggio" class="chart-container" style="margin-left: auto; margin-right: auto;">
      <canvas id="graficoMonitoraggio"></canvas>
    </div>

    <div class="last-update">
      <span class="label">Ultimo Aggiornamento:</span>
      <span class="value" id="last-update-value">--:--</span>
    </div>
  </div>

  <footer>
    &copy; 2025 - Monitoraggio CER - Tutti i diritti riservati
  </footer>

  <script>
    function fetchData() {
      let url = "dati_grafico_expo_energy.php";

      const dateStart = document.getElementById('date_start').value;
      const dateEnd = document.getElementById('date_end').value;

      if (dateStart && dateEnd) {
        url = `dati_grafico_expo_energy.php?data_inizio=${dateStart.replace('T', ' ')}:00&data_fine=${dateEnd.replace('T', ' ')}:00`;
      }

      console.log("Fetching data from:", url);

      fetch(url)
        .then(response => {
          if (!response.ok) {
            throw new Error('Network response was not ok: ' + response.status);
          }
          return response.json();
        })
        .then(data => {
          // Extract data from response
          const misure = data.misure;
          const sommaTotalePeriodo = data.somma_totale_periodo;
          console.log("Received", misure.length, "data points");
          if (!misure || misure.length === 0) {
            console.warn("No data received");
            return;
          }

          // Update the latest reading
          const ultimoAggiornamento = misure[misure.length - 1];
          document.getElementById('last-update-value').innerText = new Date(ultimoAggiornamento.data_ora).toLocaleString();
          document.getElementById('current-power-value').innerText = ultimoAggiornamento.somma_energia + " kWh";
          document.getElementById('period-power-value').innerText = sommaTotalePeriodo + " kWh";

          // Set date inputs if they're empty
          if (!dateStart || !dateEnd) {
            const dateStartObj = new Date(misure[0].data_ora);
            const dateEndObj = new Date(ultimoAggiornamento.data_ora);
            const tzOffset = dateStartObj.getTimezoneOffset() * 60000; // offset in milliseconds

            document.getElementById('date_start').value = new Date(dateStartObj - tzOffset).toISOString().slice(0, 16);
            document.getElementById('date_end').value = new Date(dateEndObj - tzOffset).toISOString().slice(0, 16);
          }

          renderChart(misure);
        })
        .catch(error => {
          console.error('Error fetching data:', error);
          alert('Si è verificato un errore durante il recupero dei dati. Riprova più tardi.');
        });
    }

    function renderChart(misure) {
      console.log("Rendering chart with", misure.length, "data points");
      const ctx = document.getElementById('graficoMonitoraggio').getContext('2d');

      // Destroy existing chart if any
      if (window.graficoMonitoraggio instanceof Chart) {
      window.graficoMonitoraggio.destroy();
      }

      // Prepare data for chart
      const dateStartStr = document.getElementById('date_start').value;
      const dateEndStr = document.getElementById('date_end').value;

      const dateStart = dateStartStr ? new Date(dateStartStr) : null;
      const dateEnd = dateEndStr ? new Date(dateEndStr) : null;

      const chartData = {
      labels: [],
      data: []
      };

      for (const misura of misure) {
      const dataOra = new Date(misura.data_ora);

      // Filter by date range if dates are selected
      if ((!dateStart || dataOra >= dateStart) && (!dateEnd || dataOra <= dateEnd)) {
        chartData.labels.push(dataOra);
        chartData.data.push(misura.potenza);
      }
      }

      // Create chart
      window.graficoMonitoraggio = new Chart(ctx, {
      type: 'line',
      data: {
        labels: chartData.labels,
        datasets: [{
        label: 'Produzione CER (kW)',
        data: chartData.data,
        borderColor: '#F2B705',
        backgroundColor: 'rgba(242, 183, 5, 0.1)',
        borderWidth: 2,
        fill: true,
        tension: 0.2,
        pointRadius: 3,
        pointHoverRadius: 5,
        pointBackgroundColor: '#F2B705',
        pointHoverBackgroundColor: '#F25C05'
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
        x: {
          type: 'time',
          time: {
          unit: 'hour',
          displayFormats: {
            hour: 'HH:mm',
            day: 'dd MMM'
          },
          tooltipFormat: 'dd MMM yyyy HH:mm'
          },
          title: {
          display: true,
          text: 'Data e Ora',
          color: '#4C8C2E',
          font: {
            size: 14,
            weight: 'bold',
          }
          },
          grid: {
          display: true,
          color: 'rgba(0, 0, 0, 0.05)',
          lineWidth: 1,
          },
          ticks: {
          color: '#666',
          font: {
            size: 11,
          },
          maxRotation: 45,
          minRotation: 45
          }
        },
        y: {
          beginAtZero: true,
          title: {
          display: true,
          text: 'Potenza (kW)',
          color: '#4C8C2E',
          font: {
            size: 14,
            weight: 'bold',
          }
          },
          grid: {
          display: true,
          color: 'rgba(0, 0, 0, 0.05)',
          lineWidth: 1,
          },
          ticks: {
          color: '#666',
          font: {
            size: 11,
          },
          callback: function (value) {
            return value;
          }
          }
        }
        },
        plugins: {
        title: {
          display: true,
          text: 'Potenza fotovoltaica istantanea',
          color: '#4C8C2E',
          font: {
          size: 16,
          weight: 'bold'
          }
        },
        legend: {
          display: false
        },
        tooltip: {
          backgroundColor: 'rgba(255, 255, 255, 0.9)',
          titleColor: '#333',
          titleFont: {
          size: 14,
          weight: 'bold'
          },
          bodyColor: '#F25C05',
          bodyFont: {
          size: 13
          },
          borderColor: '#ccc',
          borderWidth: 1,
          caretSize: 6,
          cornerRadius: 6,
          padding: 10,
          displayColors: false,
          callbacks: {
          label: function (context) {
            return context.parsed.y + ' kWh';
          }
          }
        }
        },
        interaction: {
        mode: 'index',
        intersect: false
        },
        elements: {
        line: {
          tension: 0.3
        }
        }
      }
      });
    }

    // Initial load
    fetchData();

    // Refresh data every 15 minutes (900000 ms)
    setInterval(fetchData, 900000);

    document.getElementById('toggleFilters').addEventListener('click', function () {
      const filterSection = document.getElementById('filterSection');
      const toggleButton = document.getElementById('toggleFilters');

      if (filterSection.style.display === 'none') {
        filterSection.style.display = 'flex';
        toggleButton.textContent = 'Nascondi filtri';
      } else {
        filterSection.style.display = 'none';
        toggleButton.textContent = 'Mostra filtri';
      }
    });
  </script>
</body>

</html>